from bs4 import BeautifulSoup
#from urllib.request import Request, urlopen
import urllib
import re
import json

# words that can charaterize json ClaimReview which I'd like to find
MAIN_KEYWORD = "Generated by Full Fact Claim Review Schema"
JSON_KEYWORD = ["Generated by Full Fact Claim Review Schema", "claimReviewed", "itemReviewed", "reviewRating" ]

# check if there is a keywork in the json "text"
def check_is_clamReviewed(text):

    previous = ''
    for word in text:
        
        for keyword in JSON_KEYWORD:

          #  print(word + " < - > " + previous)
            #if word == "claimReviewed" and previous == "@type":
             #   return True
            if word == keyword:
                return True
            previous = word

    return False

# read from html code if it's present a json_file, in case return the json_claimReviewed
def read_from_web(url):

    # I  extract all possible json

    html_page = urllib.request.urlopen(url)
    soup = BeautifulSoup(html_page)
    json_html = soup.find_all("script",type="application/ld+json")

    # I bring all json in an array 
    all_json = []
    for th in json_html:
        all_json.append(str(th))

    # I split every json and check if they contain a keywork
    claim_review = ''
    for j in all_json:

        splitted_json = j.split('"')
        if check_is_clamReviewed( splitted_json ) == True:
            claim_review = j

    return claim_review
   
# leave text: <script> and return only the string which the json text, return a better format 
def extract_json( claim_review_html ):
    step1 = claim_review_html.split("[")
    step2 = step1[1].split("]")
    return step2[0]

def search_for_json(url):
    claim_review_html = read_from_web(url)  

    if claim_review_html == '':
        return ''
    else:
        claim_review_json = extract_json( claim_review_html )

        loaded_json = json.loads( claim_review_json )

        return loaded_json

def find_json(line):

    # i check if the word is one of the keywork in TO_FIND
    for word in line:
        
        for keyword in TO_FIND:
            if word == keyword:

                print("find: " + str(keyword))
                return True
    
    return False


def parse_html():

    file = open("file-prova.txt", "r")
    lines = file.readlines()
    file.close()

    for line in lines():
        
        if find_json(line) == True:
            print("json Claim Review founded")



def main():
    url1 = "https://facta.news/fuori-contesto/2022/09/27/eventi-avversi-eudravigilance-minori/"
    url2 = "https://facta.news/fuori-contesto/2022/10/13/pfizer-testato-trasmissione-covid/"

    url_array = []
    url_array.append(url1)
    url_array.append(url2)

    my_json = {}
    for url in url_array:

        actual_json = search_for_json(url)
        
        if actual_json != '':
            my_json[url] = actual_json

    for k in my_json.keys():
        print("url: " + k)
        print(my_json[k])
        print()


main()
